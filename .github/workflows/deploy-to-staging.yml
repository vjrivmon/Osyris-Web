name: Deploy to Staging Environment

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      rebuild_frontend:
        description: 'Forzar rebuild completo del frontend'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'
  STAGING_PATH: /var/www/osyris-staging/current
  SERVER_USER: root
  SERVER_HOST: ${{ secrets.HETZNER_HOST }}
  STAGING_API_URL: http://116.203.98.142:5001

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ§¹ Clean workspace
        run: |
          echo "ğŸ§¹ Limpiando workspace..."
          rm -rf .next build dist 2>/dev/null || true
          npm cache clean --force || true

      - name: ğŸ“š Install dependencies
        run: |
          npm ci --prefer-offline --no-audit --no-fund
          cd api-osyris && npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ§ª Run tests
        run: npm test -- --passWithNoTests --watchAll=false || true

      - name: ğŸ”¨ Quick build check
        run: |
          npx next clean 2>/dev/null || true
          npm run build
          
          if [ ! -d ".next" ]; then
            echo "âŒ Build fallÃ³"
            exit 1
          fi
          echo "âœ… Build verificado"

  deploy-staging:
    name: Deploy to Staging
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: ğŸ“¦ Create deployment package
        run: |
          echo "ğŸ“¦ Creando paquete de despliegue para staging..."
          
          tar -czf deploy-staging.tar.gz \
            --exclude=.git \
            --exclude=logs \
            --exclude=.github \
            --exclude=node_modules \
            --exclude=api-osyris/node_modules \
            --exclude=.next \
            --exclude=api-osyris/.next \
            --exclude=build \
            --exclude=dist \
            --exclude=deploy-staging.tar.gz \
            --exclude=*.log \
            . || true

          if [ ! -f deploy-staging.tar.gz ]; then
            echo "âŒ Error: deploy-staging.tar.gz no se creÃ³"
            exit 1
          fi

          echo "ğŸ“Š TamaÃ±o del paquete:"
          ls -lh deploy-staging.tar.gz

      - name: ğŸš€ Deploy to Staging Server
        run: |
          echo "ğŸš€ Desplegando a staging..."

          # Subir archivos
          scp -o StrictHostKeyChecking=no deploy-staging.tar.gz ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.STAGING_PATH }}/

          # Script de deploy en servidor
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} bash << 'ENDSSH'
          set -e
          
          echo "ğŸ§¹ PREPARANDO ENTORNO STAGING"
          
          # Crear directorio staging si no existe
          mkdir -p ${{ env.STAGING_PATH }}
          cd ${{ env.STAGING_PATH }}

          # Backup rÃ¡pido si existe
          if [ -d "backup_staging" ]; then
            rm -rf backup_staging
          fi
          
          if [ -d "current_files" ]; then
            mv current_files backup_staging
          fi

          # Extraer archivos
          mkdir -p current_files
          tar -xzf deploy-staging.tar.gz -C current_files/
          rm deploy-staging.tar.gz

          cd current_files

          echo "ğŸ§¹ LIMPIEZA DE CACHÃ‰ STAGING"
          # Limpieza completa de cachÃ©
          rm -rf .next 2>/dev/null || true
          rm -rf node_modules/.cache 2>/dev/null || true
          rm -rf api-osyris/.next 2>/dev/null || true
          rm -rf api-osyris/node_modules/.cache 2>/dev/null || true
          rm -rf build out dist 2>/dev/null || true

          echo "ğŸ“¦ INSTALACIÃ“N DE DEPENDENCIAS STAGING"
          # Limpiar TODA la cachÃ© de npm (mÃ¡s agresivo para evitar corrupciÃ³n)
          rm -rf /root/.npm 2>/dev/null || true
          npm cache clean --force 2>/dev/null || true
          
          # Instalar dependencias frontend (usar npm install en lugar de ci para evitar problemas de cachÃ©)
          rm -rf node_modules 2>/dev/null || true
          npm install --production=false --no-audit --no-fund --legacy-peer-deps

          # Instalar dependencias backend
          cd api-osyris
          rm -rf node_modules 2>/dev/null || true
          npm install --production=false --no-audit --no-fund --legacy-peer-deps
          cd ..

          echo "ğŸ—ï¸ BUILD STAGING"
          # Limpiar y construir
          npx next clean 2>/dev/null || true
          rm -rf .next 2>/dev/null || true

          # Build con variables de staging
          export NEXT_PUBLIC_API_URL="${{ env.STAGING_API_URL }}"
          export API_BASE_URL="${{ env.STAGING_API_URL }}"
          export NODE_ENV="production"
          export NEXT_PUBLIC_STAGING="true"
          
          npm run build:frontend || npm run build

          if [ ! -d ".next" ]; then
            echo "âŒ BUILD STAGING FALLÃ“"
            exit 1
          fi
          echo "âœ… Build staging exitoso"

          # Configurar .env staging backend
          cat > api-osyris/.env << 'ENVFILE'
          NODE_ENV=staging
          PORT=5001
          DB_HOST=localhost
          DB_PORT=5432
          DB_USER=osyris_user
          DB_PASSWORD=OsyrisDB2024!Secure
          DB_NAME=osyris_staging_db
          JWT_SECRET=osyrisScoutGroup2024SecretKey!Staging
          JWT_EXPIRES_IN=24h
          FRONTEND_URL=http://116.203.98.142:3001
          ALLOWED_ORIGINS=http://116.203.98.142:3001,http://localhost:3001
          STAGING_MODE=true
          ENVFILE

          # Configurar .env.local staging frontend
          cat > .env.local << 'ENVFRONTEND'
          NEXT_PUBLIC_API_URL=${{ env.STAGING_API_URL }}
          API_BASE_URL=${{ env.STAGING_API_URL }}
          NODE_ENV=staging
          NEXT_PUBLIC_APP_NAME=Osyris Scout Management - Staging
          NEXT_PUBLIC_STAGING=true
          ENVFRONTEND

          # Mover archivos al directorio final de staging
          echo "ğŸ“ Moviendo archivos al directorio staging..."
          cd ${{ env.STAGING_PATH }}
          
          # Usar rsync para copiar archivos de forma segura
          # (preservando permisos y sin borrar hasta confirmar copia)
          if command -v rsync &> /dev/null; then
            rsync -av --delete current_files/ . --exclude current_files
          else
            # Fallback: mover archivos manualmente si rsync no estÃ¡ disponible
            shopt -s dotglob  # Incluir archivos ocultos
            for item in current_files/*; do
              if [ -e "$item" ]; then
                mv -f "$item" .
              fi
            done
            shopt -u dotglob
          fi
          
          rm -rf current_files 2>/dev/null || true

          echo "ğŸš€ REINICIANDO SERVICIOS STAGING"

          # Verificar PM2
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi

          # Detener servicios existentes
          pm2 stop osyris-staging-frontend || true
          pm2 stop osyris-staging-backend || true
          pm2 delete osyris-staging-frontend || true
          pm2 delete osyris-staging-backend || true

          # Limpiar puertos
          fuser -k 3001/tcp 2>/dev/null || true
          fuser -k 5001/tcp 2>/dev/null || true

          sleep 2

          # Iniciar backend staging
          cd ${{ env.STAGING_PATH }}
          pm2 start api-osyris/src/index.js \
            --name "osyris-staging-backend" \
            --cwd "${{ env.STAGING_PATH }}/api-osyris" \
            --node-args="--env-file=${{ env.STAGING_PATH }}/api-osyris/.env"

          sleep 3

          # Iniciar frontend staging
          pm2 start node_modules/.bin/next \
            --name "osyris-staging-frontend" \
            --cwd "${{ env.STAGING_PATH }}" \
            --node-args="--env-file=${{ env.STAGING_PATH }}/.env.local" \
            -- start -p 3001

          pm2 save

          # Verificar servicios
          echo "âœ… VERIFICACIÃ“N STAGING:"
          pm2 list | grep staging

          if ! pm2 list | grep -q "osyris-staging-frontend.*online"; then
            echo "âŒ Frontend staging no estÃ¡ online"
            pm2 logs osyris-staging-frontend --lines 20 --nostream
            exit 1
          fi

          if ! pm2 list | grep -q "osyris-staging-backend.*online"; then
            echo "âŒ Backend staging no estÃ¡ online"
            pm2 logs osyris-staging-backend --lines 20 --nostream
            exit 1
          fi

          echo "âœ… Staging deployment completado"
          ENDSSH

      - name: ğŸ§¹ Cleanup
        run: rm -f deploy-staging.tar.gz

      - name: â±ï¸ Wait for staging services
        run: |
          echo "â±ï¸ Esperando a que staging estÃ© listo..."
          sleep 15

      - name: âœ… Verify staging deployment
        run: |
          echo "ğŸ” Verificando staging..."

          # Verificar frontend staging
          FRONTEND_OK=0
          for i in {1..3}; do
            if curl -f -s -o /dev/null http://116.203.98.142:3001; then
              echo "âœ… Frontend staging OK"
              FRONTEND_OK=1
              break
            fi
            sleep 10
          done

          if [ $FRONTEND_OK -eq 0 ]; then
            echo "âŒ Frontend staging no responde"
            exit 1
          fi

          # Verificar backend staging
          BACKEND_OK=0
          for i in {1..3}; do
            if curl -f -s -o /dev/null http://116.203.98.142:5001/api/health; then
              echo "âœ… Backend staging OK"
              BACKEND_OK=1
              break
            fi
            sleep 10
          done

          if [ $BACKEND_OK -eq 0 ]; then
            echo "âš ï¸ Backend staging no responde en /health"
          fi

          echo "âœ… Staging verificado"

      - name: ğŸ“Š Staging deployment summary
        run: |
          echo "### ğŸ§ª Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**InformaciÃ³n del Despliegue:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -Iseconds)" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Acceso a Staging:**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ Frontend: http://116.203.98.142:3001" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”§ Backend API: http://116.203.98.142:5001" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**âœ… Verificaciones:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Limpieza de cachÃ© completa" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build fresco con variables de staging" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Frontend staging respondiendo" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Backend staging funcionando" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ **Staging listo para testing!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PrÃ³ximo paso:** Validar en staging y luego ejecutar:" >> $GITHUB_STEP_SUMMARY
          echo "\`./scripts/deploy-to-production-from-staging.sh\`" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send notifications
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“¬ Staging notification
        run: |
          echo "## ğŸ§ª Staging Deployment Notification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
            echo "âœ… **Deploy a staging exitoso**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Enlaces de staging:**" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸŒ Frontend: http://116.203.98.142:3001" >> $GITHUB_STEP_SUMMARY
            echo "- ğŸ”§ API: http://116.203.98.142:5001" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recuerda:** Staging es para testing, no afecta producciÃ³n" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deploy a staging fallÃ³ - revisar logs**" >> $GITHUB_STEP_SUMMARY
          fi

