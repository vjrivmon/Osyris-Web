name: Deploy to Hetzner Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  DEPLOY_PATH: /var/www/osyris
  SERVER_USER: root
  SERVER_HOST: ${{ secrets.HETZNER_HOST }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üìö Install dependencies
        run: |
          npm ci
          cd api-osyris && npm ci

      - name: üß™ Run tests
        run: npm test -- --passWithNoTests || true

      - name: üî® Build frontend
        run: npm run build

  deploy:
    name: Deploy to Hetzner
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîë Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: üì¶ Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            --exclude=node_modules \
            --exclude=.next \
            --exclude=.git \
            --exclude=logs \
            --exclude=.github \
            --exclude=api-osyris/node_modules \
            --exclude=api-osyris/database \
            . || true

          # Verificar que el archivo se cre√≥
          if [ ! -f deploy.tar.gz ]; then
            echo "Error: deploy.tar.gz no se cre√≥"
            exit 1
          fi

          ls -lh deploy.tar.gz

      - name: üöÄ Deploy to server
        run: |
          # Crear directorio si no existe
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"

          # Subir archivos
          scp -o StrictHostKeyChecking=no deploy.tar.gz ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/

          # Script de deploy en el servidor
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} bash << 'ENDSSH'
          set -e
          cd ${{ env.DEPLOY_PATH }}

          # Backup de seguridad
          if [ -d "current" ]; then
            cp -r current backup_$(date +%Y%m%d_%H%M%S)
            ls -t | grep backup_ | tail -n +6 | xargs rm -rf 2>/dev/null || true
          fi

          # Backup de base de datos
          echo "üìä Creando backup de base de datos..."
          docker exec osyris-db pg_dump -U osyris_user osyris_db | gzip > backup_db_$(date +%Y%m%d_%H%M%S).sql.gz || true
          ls -t backup_db_*.sql.gz 2>/dev/null | tail -n +11 | xargs rm -f 2>/dev/null || true

          # Extraer nuevos archivos
          mkdir -p current
          tar -xzf deploy.tar.gz -C current/
          rm deploy.tar.gz

          cd current

          # Instalar dependencias
          npm ci --production
          cd api-osyris && npm ci --production && cd ..

          # Build frontend
          npm run build

          # Reiniciar contenedores Docker
          echo "üîÑ Reiniciando servicios..."
          docker-compose -f docker-compose.prod.yml down || true
          docker-compose -f docker-compose.prod.yml up -d

          echo "‚úÖ Deploy completado exitosamente"
          ENDSSH

      - name: üßπ Cleanup
        run: rm -f deploy.tar.gz

      - name: ‚úÖ Verify deployment
        run: |
          echo "Esperando a que el servidor est√© listo..."
          sleep 15

          # Verificar que el servidor responde
          if curl -f -s -o /dev/null http://${{ env.SERVER_HOST }}; then
            echo "‚úÖ Servidor respondiendo correctamente"
          else
            echo "‚ùå Servidor no responde"
            exit 1
          fi

      - name: üìä Deployment summary
        run: |
          echo "### üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Server:** ${{ env.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üåê Access" >> $GITHUB_STEP_SUMMARY
          echo "- Server IP: http://${{ env.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send notifications
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: üì¨ Deploy notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deploy exitoso a producci√≥n"
            echo "üåê http://${{ env.SERVER_HOST }}"
          else
            echo "‚ùå Deploy fall√≥ - revisar logs"
          fi
