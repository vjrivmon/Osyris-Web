name: Deploy to Production (Build in CI, Sync to Server)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_staging:
        description: 'Saltar despliegue a staging (NO RECOMENDADO)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.x'
  # âš ï¸ IMPORTANTE: URL SIN /api al final - el cÃ³digo lo aÃ±ade
  NEXT_PUBLIC_API_URL: 'https://gruposcoutosyris.es'
  # ProducciÃ³n
  PRODUCTION_PATH: /var/www/osyris/current
  PRODUCTION_FRONTEND_PORT: 3000
  PRODUCTION_BACKEND_PORT: 5000
  PRODUCTION_DB_NAME: osyris_db
  # Staging
  STAGING_PATH: /var/www/osyris-staging/current
  STAGING_FRONTEND_PORT: 3001
  STAGING_BACKEND_PORT: 5001
  STAGING_DB_NAME: osyris_staging_db
  # Servidor
  SERVER_USER: root
  SERVER_HOST: ${{ secrets.HETZNER_HOST }}

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PASO 1: BUILD EN CI RUNNER (no en servidor - tiene poca RAM)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ğŸ”¨ Build in CI Runner
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ§¹ Clean workspace
        run: |
          rm -rf .next node_modules 2>/dev/null || true
          npm cache clean --force || true

      - name: ğŸ“š Install dependencies
        run: |
          npm ci --prefer-offline --no-audit --no-fund
          cd api-osyris && npm ci --prefer-offline --no-audit --no-fund

      - name: ğŸ§ª Run tests
        run: npm test -- --passWithNoTests --watchAll=false || true

      - name: ğŸ”¨ Build frontend with correct API URL
        run: |
          echo "ğŸ“‹ Building with NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }}"
          echo "   (SIN /api al final - el cÃ³digo lo aÃ±ade)"
          rm -rf .next
          NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }} npm run build:frontend

          if [ ! -d ".next" ]; then
            echo "âŒ Build fallÃ³ - .next no existe"
            exit 1
          fi
          echo "âœ… Build exitoso"

      - name: ğŸ“¦ Create deployment package with build
        run: |
          # Incluir .next en el paquete (ya compilado)
          tar -czf deploy.tar.gz \
            --exclude='.git' \
            --exclude='logs' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='api-osyris/node_modules' \
            --exclude='deploy.tar.gz' \
            .

          ls -lh deploy.tar.gz
          echo "âœ… Package incluye .next compilado"

      - name: ğŸ“¤ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-package
          path: deploy.tar.gz
          retention-days: 1

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PASO 2: DEPLOY A STAGING (verificaciÃ³n pre-producciÃ³n)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-staging:
    name: ğŸ§ª Deploy to Staging
    needs: build
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_staging }}

    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-package

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: ğŸš€ Deploy to Staging
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "mkdir -p ${{ env.STAGING_PATH }}"
          scp -o StrictHostKeyChecking=no deploy.tar.gz ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.STAGING_PATH }}/

          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} bash << 'ENDSSH'
          set -e
          cd ${{ env.STAGING_PATH }}

          echo "ğŸ›‘ Deteniendo servicios staging..."
          pm2 stop osyris-staging-frontend osyris-staging-backend 2>/dev/null || true

          echo "ğŸ“¦ Extrayendo build pre-compilado..."
          rm -rf .next node_modules api-osyris/node_modules 2>/dev/null || true
          tar -xzf deploy.tar.gz
          rm deploy.tar.gz

          echo "ğŸ“¦ Instalando dependencias..."
          npm ci --prefer-offline --no-audit --no-fund 2>/dev/null || npm install --legacy-peer-deps
          cd api-osyris && npm ci --omit=dev --prefer-offline 2>/dev/null || npm install && cd ..

          echo "âš™ï¸ Configurando backend staging..."
          cat > api-osyris/.env << 'ENVFILE'
          DATABASE_TYPE=postgres
          DB_HOST=localhost
          DB_PORT=5432
          DB_USER=osyris_user
          DB_PASSWORD=OsyrisDB2024!Secure
          DB_NAME=${{ env.STAGING_DB_NAME }}
          NODE_ENV=staging
          PORT=${{ env.STAGING_BACKEND_PORT }}
          JWT_SECRET=osyrisScoutGroup2024SecretKey!Staging
          JWT_EXPIRES_IN=24h
          ENVFILE

          echo "ğŸš€ Iniciando servicios staging..."
          pm2 delete osyris-staging-frontend osyris-staging-backend 2>/dev/null || true
          pm2 start "npx next start -p ${{ env.STAGING_FRONTEND_PORT }}" --name "osyris-staging-frontend"
          pm2 start api-osyris/src/index.js --name "osyris-staging-backend" --node-args="--env-file=api-osyris/.env"
          pm2 save

          echo "âœ… Staging deployment completado"
          ENDSSH

      - name: âœ… Verify Staging
        run: |
          sleep 15
          echo "ğŸ” Verificando staging..."

          for i in {1..3}; do
            if curl -f -s -o /dev/null http://116.203.98.142:${{ env.STAGING_FRONTEND_PORT }}; then
              echo "âœ… Frontend staging OK"
              break
            fi
            sleep 10
          done

          for i in {1..3}; do
            if curl -f -s -o /dev/null http://116.203.98.142:${{ env.STAGING_BACKEND_PORT }}/api/health; then
              echo "âœ… Backend staging OK"
              break
            fi
            sleep 10
          done

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PASO 3: DEPLOY A PRODUCCIÃ“N (solo sincronizar y reiniciar)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-production:
    name: ğŸš€ Deploy to Production
    needs: [build, deploy-staging]
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/main' && (success() || inputs.skip_staging) }}

    steps:
      - name: ğŸ“¥ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: deploy-package

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: ğŸš€ Deploy to Production
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "mkdir -p ${{ env.PRODUCTION_PATH }}"
          scp -o StrictHostKeyChecking=no deploy.tar.gz ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.PRODUCTION_PATH }}/

          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} bash << 'ENDSSH'
          set -e
          cd ${{ env.PRODUCTION_PATH }}

          echo "ğŸ“Š Backup de base de datos..."
          docker exec osyris-db pg_dump -U osyris_user osyris_db | gzip > backup_db_$(date +%Y%m%d_%H%M%S).sql.gz || true
          ls -t backup_db_*.sql.gz 2>/dev/null | tail -n +3 | xargs rm -f 2>/dev/null || true

          echo "ğŸ›‘ Deteniendo servicios..."
          pm2 stop osyris-frontend osyris-backend 2>/dev/null || true

          echo "ğŸ“¦ Extrayendo build pre-compilado..."
          # Preservar .env del backend
          cp api-osyris/.env /tmp/osyris-backend.env 2>/dev/null || true

          rm -rf .next node_modules api-osyris/node_modules 2>/dev/null || true
          tar -xzf deploy.tar.gz
          rm deploy.tar.gz

          # Restaurar .env si existÃ­a
          if [ -f /tmp/osyris-backend.env ]; then
            cp /tmp/osyris-backend.env api-osyris/.env
          fi

          echo "ğŸ“¦ Instalando dependencias (sin build - ya viene compilado)..."
          npm ci --prefer-offline --no-audit --no-fund 2>/dev/null || npm install --legacy-peer-deps
          cd api-osyris && npm ci --omit=dev --prefer-offline 2>/dev/null || npm install && cd ..

          echo "ğŸš€ Reiniciando servicios..."
          pm2 delete osyris-frontend osyris-backend 2>/dev/null || true

          pm2 start api-osyris/src/index.js --name "osyris-backend" --node-args="--env-file=api-osyris/.env"
          sleep 3
          pm2 start "npx next start -p ${{ env.PRODUCTION_FRONTEND_PORT }}" --name "osyris-frontend"
          pm2 save

          echo "âœ… Production deployment completado"
          pm2 list | grep osyris
          ENDSSH

      - name: âœ… Verify Production
        run: |
          sleep 15
          echo "ğŸ” Verificando producciÃ³n..."

          FRONTEND_OK=0
          for i in {1..5}; do
            if curl -f -s -o /dev/null -L https://gruposcoutosyris.es; then
              echo "âœ… Frontend producciÃ³n OK"
              FRONTEND_OK=1
              break
            fi
            sleep 10
          done

          API_OK=0
          for i in {1..5}; do
            if curl -f -s -o /dev/null -L https://gruposcoutosyris.es/api/health; then
              echo "âœ… Backend API OK"
              API_OK=1
              break
            fi
            sleep 10
          done

          if [ $FRONTEND_OK -eq 0 ] || [ $API_OK -eq 0 ]; then
            echo "âš ï¸ AlgÃºn servicio no responde - verificar manualmente"
          fi

          echo "âœ… VerificaciÃ³n completada"

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "### ğŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Strategy:** Build in CI Runner, sync to server" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ env.NEXT_PUBLIC_API_URL }} (sin /api)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URLs:**" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸŒ Frontend: https://gruposcoutosyris.es" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”§ API: https://gruposcoutosyris.es/api/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -Iseconds)" >> $GITHUB_STEP_SUMMARY
