name: Deploy to Hetzner Production

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'fix/**'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'
  DEPLOY_PATH: /var/www/osyris
  SERVER_USER: root
  SERVER_HOST: ${{ secrets.HETZNER_HOST }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“š Install dependencies
        run: |
          npm ci
          cd api-osyris && npm ci

      - name: ğŸ§ª Run tests
        run: npm test -- --passWithNoTests || true

      - name: ğŸ”¨ Build frontend
        run: npm run build:frontend

  deploy:
    name: Deploy to Hetzner
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HETZNER_SSH_KEY }}

      - name: ğŸ“¦ Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            --exclude=node_modules \
            --exclude=.next \
            --exclude=.git \
            --exclude=logs \
            --exclude=api-osyris/node_modules \
            --exclude=api-osyris/database \
            .

      - name: ğŸš€ Deploy to server
        run: |
          # Crear directorio si no existe
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"

          # Subir archivos
          scp -o StrictHostKeyChecking=no deploy.tar.gz ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/

          # Extraer y configurar en servidor
          ssh -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}

            # Backup de seguridad del cÃ³digo
            if [ -d "current" ]; then
              cp -r current backup_$(date +%Y%m%d_%H%M%S)
              # Mantener solo Ãºltimos 5 backups
              ls -t | grep backup_ | tail -n +6 | xargs rm -rf
            fi

            # Backup de base de datos ANTES del deploy
            echo "ğŸ“Š Creando backup de base de datos..."
            docker exec osyris-db pg_dump -U osyris_user osyris_db | gzip > backup_db_$(date +%Y%m%d_%H%M%S).sql.gz

            # Mantener solo Ãºltimos 10 backups de BD
            ls -t backup_db_*.sql.gz 2>/dev/null | tail -n +11 | xargs rm -f

            # Extraer nuevos archivos
            mkdir -p current
            tar -xzf deploy.tar.gz -C current/
            rm deploy.tar.gz

            cd current

            # Instalar dependencias
            npm ci --production
            cd api-osyris && npm ci --production && cd ..

            # Build frontend
            npm run build:frontend

            # Configurar variables de entorno producciÃ³n
            cat > api-osyris/.env.production <<ENVFILE
NODE_ENV=production
PORT=5000
DB_TYPE=postgres
DB_HOST=${{ secrets.DB_HOST }}
DB_PORT=${{ secrets.DB_PORT }}
DB_USER=${{ secrets.DB_USER }}
DB_PASSWORD=${{ secrets.DB_PASSWORD }}
DB_NAME=${{ secrets.DB_NAME }}
JWT_SECRET=${{ secrets.JWT_SECRET }}
JWT_EXPIRES_IN=24h
ENVFILE

            # *** MIGRACIONES DE BASE DE DATOS AUTOMÃTICAS ***
            echo "ğŸ”„ Aplicando migraciones de base de datos..."

            # Verificar si hay archivo de migraciÃ³n SQL
            if [ -f "database/migrations/migrate.sql" ]; then
              echo "ğŸ“Š Aplicando migrate.sql..."
              docker exec -i osyris-db psql -U osyris_user -d osyris_db < database/migrations/migrate.sql
              echo "âœ… Migraciones SQL aplicadas"
            fi

            # Verificar si hay script de migraciÃ³n Node.js
            if [ -f "database/migrations/migrate.js" ]; then
              echo "ğŸ“Š Ejecutando migrate.js..."
              node database/migrations/migrate.js
              echo "âœ… Script de migraciÃ³n ejecutado"
            fi

            # Aplicar todas las migraciones pendientes en carpeta migrations/
            if [ -d "database/migrations" ]; then
              for migration in database/migrations/*.sql; do
                if [ -f "$migration" ] && [ "$migration" != "database/migrations/migrate.sql" ]; then
                  echo "ğŸ“Š Aplicando: $migration"
                  docker exec -i osyris-db psql -U osyris_user -d osyris_db < "$migration" || echo "âš ï¸ Warning: Migration $migration may have issues"
                fi
              done
            fi

            # Reiniciar servicios con PM2
            pm2 restart osyris-backend || pm2 start api-osyris/src/index.js --name osyris-backend
            pm2 restart osyris-frontend || pm2 start npm --name osyris-frontend -- run start
            pm2 save

            echo "âœ… Deploy completado exitosamente (cÃ³digo + migraciones BD)"
          EOF

      - name: ğŸ§¹ Cleanup
        run: rm -f deploy.tar.gz

      - name: âœ… Verify deployment
        run: |
          echo "Esperando a que el servidor estÃ© listo..."
          sleep 10

          # Verificar backend
          if curl -f -s -o /dev/null https://api.grupooosyris.es/api/health; then
            echo "âœ… Backend respondiendo correctamente"
          else
            echo "âŒ Backend no responde"
            exit 1
          fi

          # Verificar frontend
          if curl -f -s -o /dev/null https://grupooosyris.es; then
            echo "âœ… Frontend respondiendo correctamente"
          else
            echo "âŒ Frontend no responde"
            exit 1
          fi

      - name: ğŸ“Š Deployment summary
        run: |
          echo "### ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** Production (Hetzner)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ URLs" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: https://grupooosyris.es" >> $GITHUB_STEP_SUMMARY
          echo "- API: https://api.grupooosyris.es" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY

  notify:
    name: Send notifications
    needs: deploy
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“¬ Deploy notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deploy exitoso a producciÃ³n"
            echo "ğŸŒ https://grupooosyris.es"
          else
            echo "âŒ Deploy fallÃ³ - revisar logs"
          fi
