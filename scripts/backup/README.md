# üîÑ Sistema de Backups Autom√°ticos - Osyris

## üìã Descripci√≥n

Sistema completo de backups que **reemplaza el servicio de pago de Hetzner**, ahorr√°ndote **‚Ç¨3-5/mes**.

### Caracter√≠sticas:
- ‚úÖ **Backups diarios autom√°ticos** de BD y archivos
- ‚úÖ **Rotaci√≥n inteligente** (√∫ltimos 7 d√≠as locales)
- ‚úÖ **Backups offsite** en GitHub (30 d√≠as)
- ‚úÖ **Cifrado GPG** opcional para seguridad
- ‚úÖ **Restauraci√≥n con 1 comando**
- ‚úÖ **Verificaci√≥n de integridad** autom√°tica
- ‚úÖ **100% gratuito** (usa GitHub gratis)

---

## üèóÔ∏è Arquitectura del Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           SERVIDOR HETZNER                      ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ  PostgreSQL  ‚îÇ      ‚îÇ   Uploads/   ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ   Database   ‚îÇ      ‚îÇ    .env      ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ         ‚îÇ                     ‚îÇ                ‚îÇ
‚îÇ         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                ‚îÇ
‚îÇ         ‚Üì                     ‚Üì                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îÇ
‚îÇ  ‚îÇ    Backup Scripts (Cronjobs)       ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  - backup-database.sh (2 AM)       ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  - backup-files.sh (3 AM)          ‚îÇ       ‚îÇ
‚îÇ  ‚îÇ  - backup-to-github.sh (4 AM)      ‚îÇ       ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îÇ
‚îÇ         ‚îÇ                     ‚îÇ                ‚îÇ
‚îÇ         ‚Üì                     ‚Üì                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  Local Backups  ‚îÇ   ‚îÇ  Local Backups  ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ   /var/backups/ ‚îÇ   ‚îÇ   /var/backups/ ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ    database/    ‚îÇ   ‚îÇ     files/      ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  (√∫ltimos 7)    ‚îÇ   ‚îÇ  (√∫ltimos 7)    ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ         ‚îÇ                                      ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ                        ‚Üì
‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              ‚îÇ  Cifrado GPG     ‚îÇ
‚îÇ              ‚îÇ   (opcional)     ‚îÇ
‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ                     ‚Üì
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚Üì
            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            ‚îÇ   GITHUB         ‚îÇ
            ‚îÇ  (Offsite)       ‚îÇ
            ‚îÇ  vicente/        ‚îÇ
            ‚îÇ  osyris-backups  ‚îÇ
            ‚îÇ  (√∫ltimos 30)    ‚îÇ
            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üöÄ Instalaci√≥n

### Paso 1: Copiar scripts al servidor

```bash
# Desde tu m√°quina local
cd /home/vicente/RoadToDevOps/osyris/Osyris-Web

# Copiar a servidor
scp -r scripts/backup root@116.203.98.142:/root/

# Conectar al servidor
ssh root@116.203.98.142
```

### Paso 2: Dar permisos de ejecuci√≥n

```bash
chmod +x /root/backup/*.sh
```

### Paso 3: Crear directorios de backups

```bash
mkdir -p /var/backups/osyris/database
mkdir -p /var/backups/osyris/files
```

### Paso 4: (Opcional) Configurar GPG para cifrado

```bash
# Generar clave GPG
gpg --gen-key
# Seguir wizard, usar email: osyris@backup

# Exportar ID de la clave
gpg --list-keys
# Copiar el ID de la clave generada

# A√±adir a variables de entorno
echo 'export OSYRIS_GPG_KEY_ID="tu-key-id-aqui"' >> ~/.bashrc
source ~/.bashrc
```

### Paso 5: Configurar GitHub

#### Opci√≥n A: Crear repositorio privado (Recomendado)

```bash
# 1. Crear repo privado en GitHub:
# https://github.com/new
# Nombre: osyris-backups
# Tipo: Private

# 2. Configurar SSH en el servidor (si no est√°)
ssh-keygen -t ed25519 -C "backup@osyris"
cat ~/.ssh/id_ed25519.pub
# Copiar la clave y a√±adirla en: https://github.com/settings/keys

# 3. Clonar el repo vac√≠o
cd /tmp
git clone git@github.com:tu-usuario/osyris-backups.git
cd osyris-backups
touch README.md
echo "# Backups Osyris (Privado)" > README.md
git add .
git commit -m "Initial commit"
git push origin main
```

#### Opci√≥n B: Sin GitHub (solo backups locales)

Si no quieres usar GitHub, **comenta** el cronjob de `backup-to-github.sh`.

### Paso 6: Configurar Cronjobs

```bash
# Editar crontab
crontab -e

# A√±adir estas l√≠neas:
# Backup de base de datos a las 2 AM
0 2 * * * /root/backup/backup-database.sh >> /var/log/osyris-backups.log 2>&1

# Backup de archivos a las 3 AM
0 3 * * * /root/backup/backup-files.sh >> /var/log/osyris-backups.log 2>&1

# Backup offsite (GitHub) a las 4 AM (opcional)
0 4 * * * /root/backup/backup-to-github.sh >> /var/log/osyris-backups.log 2>&1
```

### Paso 7: Probar manualmente

```bash
# Probar backup de BD
/root/backup/backup-database.sh

# Probar backup de archivos
/root/backup/backup-files.sh

# Probar backup a GitHub (si configurado)
/root/backup/backup-to-github.sh
```

---

## üìñ Uso

### Ver backups disponibles

```bash
# Backups de base de datos
ls -lh /var/backups/osyris/database/

# Backups de archivos
ls -lh /var/backups/osyris/files/

# Logs
tail -f /var/log/osyris-backups.log
```

### Restaurar backups

#### Restaurar √∫ltima base de datos

```bash
/root/backup/restore-backup.sh database
```

#### Restaurar √∫ltimos archivos

```bash
/root/backup/restore-backup.sh files
```

#### Restaurar todo

```bash
/root/backup/restore-backup.sh all
```

#### Restaurar backup espec√≠fico

```bash
# Listar backups disponibles
ls /var/backups/osyris/database/

# Restaurar uno espec√≠fico (copiar fecha del nombre)
/root/backup/restore-backup.sh database 20251003_020000
```

### Restaurar desde GitHub (disaster recovery)

```bash
# 1. Clonar repo de backups
cd /tmp
git clone git@github.com:tu-usuario/osyris-backups.git

# 2. Si est√°n cifrados, descifrar
cd osyris-backups/database
gpg --decrypt osyris_db_20251003_020000.sql.gz.gpg > /tmp/backup.sql.gz

# 3. Restaurar
/root/backup/restore-backup.sh database /tmp/backup.sql.gz
```

---

## üîß Configuraci√≥n Avanzada

### Cambiar retenci√≥n de backups locales

Editar `backup-database.sh` y `backup-files.sh`:

```bash
RETENTION_DAYS=7  # Cambiar a los d√≠as deseados
```

### Cambiar retenci√≥n en GitHub

Editar `backup-to-github.sh`:

```bash
GITHUB_RETENTION_DAYS=30  # Cambiar a los d√≠as deseados
```

### Deshabilitar cifrado

Editar `backup-to-github.sh`:

```bash
ENCRYPT_BACKUPS=false  # Cambiar a false
```

### Cambiar horarios de backup

```bash
# Editar crontab
crontab -e

# Formato: minuto hora d√≠a mes d√≠a-semana comando
# Ejemplo: backup a las 11 PM
0 23 * * * /root/backup/backup-database.sh >> /var/log/osyris-backups.log 2>&1
```

---

## üìä Monitoreo

### Ver logs en tiempo real

```bash
tail -f /var/log/osyris-backups.log
```

### Ver √∫ltimo backup

```bash
# Base de datos
ls -lht /var/backups/osyris/database/ | head -2

# Archivos
ls -lht /var/backups/osyris/files/ | head -2
```

### Verificar espacio en disco

```bash
# Espacio usado por backups
du -sh /var/backups/osyris/

# Espacio libre en disco
df -h /var/backups
```

### Verificar cronjobs est√°n activos

```bash
# Listar cronjobs
crontab -l

# Ver logs del sistema de cron
grep CRON /var/log/syslog | tail -20
```

---

## üí∞ Ahorro de Costos

### Comparaci√≥n con Hetzner Backups:

| Concepto | Hetzner Backups | Este Sistema |
|----------|----------------|--------------|
| **Costo mensual** | ‚Ç¨3-5 | **‚Ç¨0** |
| **Retenci√≥n local** | No especificado | 7 d√≠as |
| **Retenci√≥n offsite** | No | 30 d√≠as (GitHub) |
| **Cifrado** | S√≠ | S√≠ (opcional GPG) |
| **Control total** | No | **S√≠** |
| **Restauraci√≥n** | Desde panel | **1 comando** |
| **Costo anual** | ‚Ç¨36-60 | **‚Ç¨0** |

### Ahorro en 3 a√±os: **‚Ç¨108-180** üí∞

---

## ‚ö†Ô∏è Notas Importantes

### Seguridad:
- ‚úÖ **Repositorio PRIVADO** en GitHub (muy importante)
- ‚úÖ **Cifrado GPG** recomendado para datos sensibles
- ‚úÖ **SSH keys** para acceso seguro

### Espacio en disco:
- Un backup completo (BD + archivos) ocupa ~50-100MB
- 7 d√≠as locales = ~350-700MB
- GitHub Free permite repos privados ilimitados

### Backup de .env:
- Los archivos `.env` se incluyen en backups de archivos
- **Mantener repo GitHub PRIVADO** por las credenciales

---

## üÜò Troubleshooting

### Error: "Permission denied"
```bash
chmod +x /root/backup/*.sh
```

### Error: "Docker not running"
```bash
systemctl status docker
systemctl start docker
```

### Error: "Cannot clone GitHub repo"
```bash
# Verificar SSH key
ssh -T git@github.com

# Si falla, a√±adir clave SSH:
cat ~/.ssh/id_ed25519.pub
# Copiar y a√±adir en: https://github.com/settings/keys
```

### Backup muy grande
```bash
# Verificar tama√±o de uploads
du -sh /var/www/osyris/current/uploads

# Limpiar archivos antiguos si es necesario
find /var/www/osyris/current/uploads -type f -mtime +90 -delete
```

---

## üéâ Resumen

Con este sistema tienes:
- ‚úÖ **Backups autom√°ticos** diarios
- ‚úÖ **Sin costos** adicionales
- ‚úÖ **Disaster recovery** completo
- ‚úÖ **Control total** del proceso
- ‚úÖ **Restauraci√≥n f√°cil**
- ‚úÖ **Ahorro de ‚Ç¨36-60/a√±o**

**¬°Tu aplicaci√≥n est√° segura!** üõ°Ô∏è
